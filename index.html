Telegram.WebApp.onEvent("web_app_open", () => {
    logToConsole("Получение состояния...");
    Telegram.WebApp.sendData(JSON.stringify({ action: "get_status" }));
});

Telegram.WebApp.onEvent("web_app_data", (data) => {
    const parsedData = JSON.parse(data);
    logToConsole(`Получены данные: ${JSON.stringify(parsedData)}`);

    if (parsedData.action === "status") {
        isParsing = parsedData.is_parsing;
        elapsedTime = parsedData.elapsed_time;
        if (isParsing) {
            startBtn.style.display = 'none';
            stopBtn.style.display = 'inline-block';
            startTimer();
            logToConsole("Парсинг продолжается...");
        } else {
            startBtn.style.display = 'inline-block';
            stopBtn.style.display = 'none';
            stopTimer();
        }
    } else if (parsedData.action === "stats") {
        stopTimer();
        statsDisplay.innerHTML = `
            <h2>Результаты парсинга:</h2>
            <p>Новые товары: ${parsedData.new_products}</p>
            <p>Цены добавлены: ${parsedData.prices_added}</p>
            <p>Остатки добавлены: ${parsedData.stocks_added}</p>
            <p>Рейтинги добавлены: ${parsedData.ratings_added}</p>
            <p>Отзывы добавлены: ${parsedData.reviews_added}</p>
            <p>Общее время: ${parsedData.elapsed_time}</p>
        `;
        isParsing = false;
        startBtn.style.display = 'inline-block';
        stopBtn.style.display = 'none';
        logToConsole("Парсинг завершён.");
    }
});
